<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>GxE Analysis Workshop</title>
    <meta charset="utf-8" />
    <meta name="author" content="Ellena Girma" />
    <script src="index_files/header-attrs-2.13/header-attrs.js"></script>
    <link href="index_files/panelset-0.2.6/panelset.css" rel="stylesheet" />
    <script src="index_files/panelset-0.2.6/panelset.js"></script>
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

.title[
# GxE Analysis Workshop
]
.author[
### Ellena Girma
]
.date[
### 2022/05/27 (updated: 2022-05-16)
]

---






<style>.shareagain-bar {
--shareagain-foreground: rgb(255, 255, 255);
--shareagain-background: rgba(0, 0, 0, 0.5);
--shareagain-facebook: none;
--shareagain-pinterest: none;
--shareagain-reddit: none;
}</style>





## Intro to Presentation

Hello Everyone! My name is Ellena Girma and I am a data analyst intern at CIAT. 

The goal of this presentation is to introduce you to R and packages in R that can help you with running GxE studies. I will take you through the GxE analysis workflow that I use. 

---

## Introduction to GxE Studies 

.pull-left[
Understanding Genotype-Environment (GxE) Interaction
* GXE interaction: the interaction of genotypes and environmental conditions and its joint effect on the traits being selected

* Is there a pattern of phenotypic expression of the selected trait across various environmental conditions? 
]

.pull-right[
Selecting &amp; recommending genotypes that have wider or more specific adaptation across various environmental conditions

* Stability: Does the performance of the genotype stay the same across environments?

* Yield Production: Does the genotype perform well across environments? 
]

---

## My Workflow: How I get from data to 


Data Preparation 

Exploratory Data Analysis

Means and High Yielding Genotypes &amp; Locations

Analysis of Variance (ANOVA)

GGE Biplots

Stability Analysis

Additive Main-Effects Multiplicative Interaction (AMMI)

---

## Intro to R and R packages 

Let's take a quick tour of R. 

For this workshop, we'll be using the tidyverse and metan packages.

---

## Importing Data and Loading Packages




```r
#loading metan package into workspace
library(metan)

#loading tidyverse package into workspace
library(tidyverse)

bean_data &lt;- read.csv("C:/Users/eruph/Documents/TB/Importing_Blog/csvfile.csv", header=TRUE, colClasses = c(rep("factor", 3), rep("numeric", 5)))
```

---

## Exploratory Data Analysis (EDA)

Exploring and summarizing datasets using summary statistics and plots/data visualization methods.

EDA allows us to:

* find outliers
* see how our data is distributed
* get summary statistics for each variable of interest
* see the relationship between variables

---

## Summary Statistics

.panelset[
.panel[.panel-name[R Code]

```r
#summary of data
summary &lt;- summary(bean_data)

#count number of fields that are missing
sum(is.na(bean_data))
```

```
## [1] 0
```

```r
#descriptive stats using metan package
ds_all &lt;- desc_stat(bean_data, stats= "main")
```
]

.panel[.panel-name[Summary Output]

```r
print(summary)
```

```
##      Site     Rep                Genotype         DF          pods.plant   
##  Selian:297   1:297   ACC 714        :  9   Min.   :33.00   Min.   : 2.60  
##  SUA   :297   2:297   Bagara Ompigize:  9   1st Qu.:38.00   1st Qu.: 9.40  
##  Uyole :297   3:297   Bangaya Akatebe:  9   Median :39.00   Median :13.40  
##                       Bilfa 4        :  9   Mean   :39.54   Mean   :14.78  
##                       Bilfa Uyole    :  9   3rd Qu.:42.00   3rd Qu.:18.00  
##                       Buji           :  9   Max.   :48.00   Max.   :46.60  
##                       (Other)        :837                                  
##    seeds.pod           sw            yield       
##  Min.   :2.600   Min.   :15.30   Min.   : 498.2  
##  1st Qu.:4.000   1st Qu.:25.50   1st Qu.:1282.2  
##  Median :4.800   Median :35.00   Median :1601.7  
##  Mean   :4.816   Mean   :35.22   Mean   :1754.3  
##  3rd Qu.:5.600   3rd Qu.:42.00   3rd Qu.:2048.9  
##  Max.   :7.600   Max.   :67.00   Max.   :5152.6  
## 
```
]

.panel[.panel-name[desc_stats Output]

```r
print(ds_all)
```

```
## # A tibble: 5 x 9
##   variable      cv    max    mean median   min sd.amo      se      ci
##   &lt;chr&gt;      &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
## 1 DF          7.02   48     39.5    39    33     2.77  0.093   0.182 
## 2 pods.plant 48.1    46.6   14.8    13.4   2.6   7.11  0.238   0.467 
## 3 seeds.pod  21.3     7.6    4.82    4.8   2.6   1.02  0.0343  0.0673
## 4 sw         32.9    67     35.2    35    15.3  11.6   0.389   0.763 
## 5 yield      43.0  5153.  1754.   1602.  498.  754.   25.3    49.6
```
]
]

---

## Checking for Outliers Pt 1: Visuals

.panelset[
.panel[.panel-name[Code]

```r
##Checking for possible outliers using metan package 
#Checking for potential outliers in yield variable
#change var = var_name to get potential outliers for another variable 
find_outliers(bean_data, var = yield, plots =T)
```



]

.panel[.panel-name[Output]

![](index_files/figure-html/outliers-1.png)&lt;!-- --&gt;

```
## Trait: yield 
## Number of possible outliers: 37 
## Line(s): 10 28 32 35 58 66 68 69 74 75 84 93 109 127 131 134 157 165 167 168 173 174 183 192 208 209 226 230 233 256 264 266 267 272 273 282 291 
## Proportion: 4.3%
## Mean of the outliers: 4314.67 
## Maximum of the outliers: 5152.6  | Line 208 
## Minimum of the outliers: 3241.9  | Line 28 
## With outliers:    mean = 1754.348 | CV = 42.991%
## Without outliers: mean = 1643.421 | CV = 32.131%
```



]
]

---

## Checking for Outliers Pt 2


```r
#potential outliers
yield_outliers &lt;- c(10, 28, 32, 35, 58, 66, 68, 69, 74 ,75, 84, 93, 109, 127, 131, 134, 157, 165, 167, 168, 173, 174, 183, 192, 208, 209, 226, 230, 233, 256, 264, 266, 267, 272, 273, 282, 291)

yo &lt;- bean_data %&gt;%
  slice(yield_outliers) %&gt;%
  arrange(Genotype) %&gt;%
  slice(1:10)

yo
```

```
##      Site Rep      Genotype DF pods.plant seeds.pod sw  yield
## 1  Selian   1        Cheupe 44       44.8       7.6 33 5085.3
## 2  Selian   2        Cheupe 44       46.2       7.4 33 5127.8
## 3  Selian   3        Cheupe 43       46.6       6.8 33 5152.6
## 4  Selian   3 Chumba Neroza 38       15.4       5.8 31 3478.7
## 5  Selian   1        Kanade 38       24.2       5.4 42 3241.9
## 6  Selian   2        Kanade 38       23.8       5.4 42 3245.4
## 7  Selian   3        Kanade 39       24.8       5.4 42 3291.5
## 8  Selian   1       Katuku2 39       36.2       5.2 40 4309.2
## 9  Selian   2       Katuku2 39       35.2       5.0 40 4256.0
## 10 Selian   3       Katuku2 39       35.0       5.4 40 4245.4
```

---

## Grand Yield Means Across Genotype

.panelset[
.panel[.panel-name[Rcode]

```r
#getting means by Genotype
mg &lt;- means_by(bean_data, Genotype)

#Creating a new object with Ordered Means by Genotype
mg_y &lt;- mg %&gt;%
  select(Genotype, yield) %&gt;%
  arrange(desc(yield))
```
]

.panel[.panel-name[Output]

```r
slice(mg_y, 1:10)
```

```
## # A tibble: 10 x 2
##    Genotype     yield
##    &lt;fct&gt;        &lt;dbl&gt;
##  1 Cheupe       3144.
##  2 Selian 15    3086.
##  3 Ruondera     2906.
##  4 Nyeupe Kubwa 2894.
##  5 Selian 14    2778.
##  6 Uyole 84     2722.
##  7 Selian 05    2711.
##  8 Soya Mbeya   2680.
##  9 Kikobe       2546.
## 10 Jabeyila     2476.
```
]
]

---

## Yield Means Across Locations 

.panelset[
.panel[.panel-name[Code]

```r
#getting means for all variables by Location
me &lt;- means_by(bean_data, Site)

#Creating a new object with Ordered Means by Location
me_y &lt;- me %&gt;%
  select(Site, yield) %&gt;%
  arrange(desc(yield))
```
]

.panel[.genotype-means[Output]

```r
me_y
```

```
## # A tibble: 3 x 2
##   Site   yield
##   &lt;fct&gt;  &lt;dbl&gt;
## 1 Selian 2336.
## 2 Uyole  1579.
## 3 SUA    1347.
```
]
]

---

## Yield Ranks and Top Performers

This code shows the Top Performing Genotype at Each Location. 

.pull-left[

```r
#top performing genotype in each env for yield
win &lt;- ge_winners(bean_data, Site, Genotype, resp = yield)
```
]

.pull-right[

```r
print(win)
```

```
## # A tibble: 3 x 2
##   ENV    yield    
##   &lt;fct&gt;  &lt;chr&gt;    
## 1 Selian Cheupe   
## 2 SUA    Jabeyila 
## 3 Uyole  Selian 14
```
]

---

## Analysis of Variance (ANOVA): Introduction 

The metan package 

---

## ANOVA for RCBD using Metan

The metan package has different functions for single site and combined site ANOVA. anova_joint() is for combined site analysis.

.panelset[
.panel[.panel-name[R Code]

```r
#Running joint anova for rcbd layout/plot design
rcbd_anova &lt;- anova_joint(bean_data, env = "Site", gen = "Genotype", rep = "Rep", resp = everything())

#getting the ANOVA table for yield 
rcbd_anova_yield &lt;- rcbd_anova$yield$anova
```



]

.panel[.panel-name[ANOVA Table]

```
## variable DF 
## ---------------------------------------------------------------------------
## Joint ANOVA table
## ---------------------------------------------------------------------------
##     Source     Df  Sum Sq Mean Sq F value    Pr(&gt;F)
##        ENV   2.00  376.14 188.071  744.25 7.96e-162
##   REP(ENV)   6.00    6.75   1.125    4.45  2.04e-04
##        GEN  98.00 3804.08  38.817  153.61  0.00e+00
##    GEN:ENV 196.00 2515.86  12.836   50.80 6.66e-278
##  Residuals 588.00  148.59   0.253      NA        NA
##      CV(%)   1.27      NA      NA      NA        NA
##  MSR+/MSR-   2.59      NA      NA      NA        NA
##     OVmean  39.54      NA      NA      NA        NA
## ---------------------------------------------------------------------------
## 
## variable pods.plant 
## ---------------------------------------------------------------------------
## Joint ANOVA table
## ---------------------------------------------------------------------------
##     Source     Df  Sum Sq Mean Sq F value    Pr(&gt;F)
##        ENV   2.00 11659.5 5829.76 2728.01 3.07e-298
##   REP(ENV)   6.00    99.8   16.64    7.79  4.47e-08
##        GEN  98.00 22094.5  225.45  105.50 5.81e-316
##    GEN:ENV 196.00  9819.5   50.10   23.44 7.16e-190
##  Residuals 588.00  1256.6    2.14      NA        NA
##      CV(%)   9.89      NA      NA      NA        NA
##  MSR+/MSR-  12.30      NA      NA      NA        NA
##     OVmean  14.78      NA      NA      NA        NA
## ---------------------------------------------------------------------------
## 
## variable seeds.pod 
## ---------------------------------------------------------------------------
## Joint ANOVA table
## ---------------------------------------------------------------------------
##     Source     Df Sum Sq Mean Sq F value    Pr(&gt;F)
##        ENV   2.00  22.30 11.1500  129.08  3.35e-47
##   REP(ENV)   6.00   1.46  0.2439    2.82  1.02e-02
##        GEN  98.00 684.52  6.9849   80.86 2.02e-284
##    GEN:ENV 196.00 174.30  0.8893   10.30 9.50e-108
##  Residuals 588.00  50.79  0.0864      NA        NA
##      CV(%)   6.10     NA      NA      NA        NA
##  MSR+/MSR-   2.20     NA      NA      NA        NA
##     OVmean   4.82     NA      NA      NA        NA
## ---------------------------------------------------------------------------
## 
## variable sw 
## ---------------------------------------------------------------------------
## Joint ANOVA table
## ---------------------------------------------------------------------------
##     Source     Df   Sum Sq  Mean Sq  F value Pr(&gt;F)
##        ENV   2.00 27392.55 1.37e+04 51909.69  0.000
##   REP(ENV)   6.00     2.41 4.02e-01     1.52  0.168
##        GEN  98.00 85390.27 8.71e+02  3302.39  0.000
##    GEN:ENV 196.00  6922.38 3.53e+01   133.86  0.000
##  Residuals 588.00   155.14 2.64e-01       NA     NA
##      CV(%)   1.46       NA       NA       NA     NA
##  MSR+/MSR-   2.32       NA       NA       NA     NA
##     OVmean  35.22       NA       NA       NA     NA
## ---------------------------------------------------------------------------
## 
## variable yield 
## ---------------------------------------------------------------------------
## Joint ANOVA table
## ---------------------------------------------------------------------------
##     Source      Df   Sum Sq  Mean Sq F value    Pr(&gt;F)
##        ENV    2.00 1.59e+08 79437488 3943.98  0.00e+00
##   REP(ENV)    6.00 7.60e+05   126648    6.29  2.02e-06
##        GEN   98.00 1.99e+08  2031096  100.84 1.45e-310
##    GEN:ENV  196.00 1.36e+08   692545   34.38 1.55e-232
##  Residuals  588.00 1.18e+07    20141      NA        NA
##      CV(%)    8.09       NA       NA      NA        NA
##  MSR+/MSR-    6.29       NA       NA      NA        NA
##     OVmean 1754.35       NA       NA      NA        NA
## ---------------------------------------------------------------------------
## 
## All variables with significant (p &lt; 0.05) genotype-vs-environment interaction
## Done!
```



]
]

---

## Estimating Variance Components Pt 1

Variance components can be calculated using the results from the ANOVA table.  

.panelset[
.panel[.panel-name[Calculating Values]

```r
#variance of line
Vl.yd &lt;- (rcbd_anova_yield[3,4] - rcbd_anova_yield[4,4])/(3*3)

#variance of line by site
Vls.yd &lt;- (rcbd_anova_yield[4,4] - rcbd_anova_yield[5,4])/(3)

#variance of error
Ve.yd &lt;- rcbd_anova_yield[5,4]

#Broad sense hertitability 
H2.yd &lt;- Vl.yd/(Vl.yd + Vls.yd + Ve.yd)

#Hertitability of Line Means
H2L.yd &lt;- Vl.yd/(Vl.yd + Vls.yd/3 + Ve.yd/(3*3))
```
]

.panel[.panel-name[Combing Values into Table]

```r
comb.site.vc &lt;- cbind(rbind(Vl.yd, Vls.yd, Ve.yd, H2.yd, H2L.yd))

colnames(comb.site.vc) &lt;- c("Yield")
rownames(comb.site.vc) = c("V of Line", "V of Line x Site", "V of Error", "Broad Sense Heritability", "Heritability of Line Means")
```
]

.panel[.panel-name[Final Output]

```r
print(comb.site.vc)
```

```
##                                   Yield
## V of Line                  1.487278e+05
## V of Line x Site           2.241346e+05
## V of Error                 2.014147e+04
## Broad Sense Heritability   3.784386e-01
## Heritability of Line Means 6.590287e-01
```
]
]

---

## Estimating Variance Components Pt 2

Divide all by VP? bc expressed as proportions to the phenotypic variances for yield across the environments

---

## GGE Biplots




---

## Stability 

---

## AMMI 

---

## AMMI Biplot

---

## Ranks: Yield Output and Stability 

ASV and YSI are the metrics I use/come across most frequently. Ranking genotypes using these metrics is useful because it takes into consideration both yield output and stability. 

---


---

## Follow Up Resources 

The link to this presentation will be emailed to you, along with a pdf copy.

Check out my &lt;a href = rforplantbreeders.netlify.app&gt; blog &lt;/a&gt; for more detailed written tutorials for plant breeders who want to learn how to use R. 

Current Posts:
  &lt;a href = rforplantbreeders.netlify.app&gt; Introduction to R &lt;/a&gt;
  &lt;a href = rforplantbreeders.netlify.app&gt; Importing in R &lt;/a&gt;

---

## QnA 

---


    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
