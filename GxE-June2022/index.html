<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>GxE Analysis Workshop</title>
    <meta charset="utf-8" />
    <meta name="author" content="Ellena Girma" />
    <script src="index_files/header-attrs-2.13/header-attrs.js"></script>
    <link href="index_files/panelset-0.2.6/panelset.css" rel="stylesheet" />
    <script src="index_files/panelset-0.2.6/panelset.js"></script>
    <script src="index_files/clipboard-2.0.6/clipboard.min.js"></script>
    <link href="index_files/xaringanExtra-clipboard-0.2.6/xaringanExtra-clipboard.css" rel="stylesheet" />
    <script src="index_files/xaringanExtra-clipboard-0.2.6/xaringanExtra-clipboard.js"></script>
    <script>window.xaringanExtraClipboard(null, {"button":"Copy to clipboard","success":"Copied","error":"Press Ctrl + C para to copy"})</script>
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

.title[
# GxE Analysis Workshop
]
.author[
### Ellena Girma
]
.date[
### 2022/05/27 (updated: 2022-05-19)
]

---

class: middle, center





<style>.shareagain-bar {
--shareagain-foreground: rgb(255, 255, 255);
--shareagain-background: rgba(0, 0, 0, 0.5);
--shareagain-facebook: none;
--shareagain-pinterest: none;
--shareagain-reddit: none;
}</style>







## Introduction to the Presentation

--

#### Hello Everyone! My name is Ellena Girma and I am a data analyst intern at CIAT. 

--

#### The goal of this presentation is to demonstrate how R can be used to run GxE analyses.

--

#### I will take you through the workflow that I use to run my GxE analysis. For each part, I will cover the main functions that I use and what outputs/results you can expect to get.

---

## Introduction to GxE Studies 

.pull-left[
Understanding Genotype-Environment (GxE) Interaction
* GXE interaction: the interaction of genotypes and environmental conditions and its joint effect on the traits being selected

* Is there a pattern of phenotypic expression of the selected trait across various environmental conditions? 
]

.pull-right[
Selecting &amp; recommending genotypes that have wider or more specific adaptation across various environmental conditions

* Stability: Does the performance of the genotype stay the same across environments?

* Yield Production: Does the genotype perform well across environments? 
]

---

## My Workflow

#### In this presentation I will be sharing the process I use to get from raw data to results. I will be focusing on the response variable yield but the code I use can be altered for other response variables too. 

Workflow:

* Data Preparation 

* Exploratory Data Analysis

* Means and High Yielding Genotypes &amp; Locations

* Analysis of Variance (ANOVA)

* GGE Biplots

* Stability Analysis

* Additive Main-Effects Multiplicative Interaction (AMMI)

---
class: middle, center, inverse

## Let's take a quick tour of R. 



## For this workshop, we'll be focusing on the metan packages.

---

## Loading Packages and Importing Data




```r
#loading metan package into workspace
#for analysis
library(metan)

#loading tidyverse package into workspace
#for data manipulation functions
library(tidyverse)

#importing a csv file using the read.csv() function
bean_data &lt;- read.csv("C:/Users/eruph/Documents/TB/Importing_Blog/csvfile.csv", 
                      header=TRUE,
                      colClasses = c(rep("factor", 3), rep("numeric", 5)))
```

---
class: middle, , center

## Exploratory Data Analysis (EDA)

### Exploring and summarizing datasets using summary statistics and plots/data visualization methods.

EDA allows us to:

* find outliers

* see how our data is distributed

* see the relationship between variables

* get summary statistics for each variable of interest

---

## Summary Statistics

.panelset[
.panel[.panel-name[R Code]

```r
#summary of data
summary &lt;- summary(bean_data)

#count number of fields that are missing
sum(is.na(bean_data))
```

```
## [1] 0
```

```r
#descriptive stats using metan package
ds_all &lt;- desc_stat(bean_data, stats= "main")
```
]

.panel[.panel-name[summary output]

```r
print(summary)
```

```
##      Site     Rep                Genotype         DF          pods.plant   
##  Selian:297   1:297   ACC 714        :  9   Min.   :33.00   Min.   : 2.60  
##  SUA   :297   2:297   Bagara Ompigize:  9   1st Qu.:38.00   1st Qu.: 9.40  
##  Uyole :297   3:297   Bangaya Akatebe:  9   Median :39.00   Median :13.40  
##                       Bilfa 4        :  9   Mean   :39.54   Mean   :14.78  
##                       Bilfa Uyole    :  9   3rd Qu.:42.00   3rd Qu.:18.00  
##                       Buji           :  9   Max.   :48.00   Max.   :46.60  
##                       (Other)        :837                                  
##    seeds.pod           sw            yield       
##  Min.   :2.600   Min.   :15.30   Min.   : 498.2  
##  1st Qu.:4.000   1st Qu.:25.50   1st Qu.:1282.2  
##  Median :4.800   Median :35.00   Median :1601.7  
##  Mean   :4.816   Mean   :35.22   Mean   :1754.3  
##  3rd Qu.:5.600   3rd Qu.:42.00   3rd Qu.:2048.9  
##  Max.   :7.600   Max.   :67.00   Max.   :5152.6  
## 
```
]

.panel[.panel-name[desc_stats output]

```r
print(ds_all)
```

```
## # A tibble: 5 x 9
##   variable      cv    max    mean median   min sd.amo      se      ci
##   &lt;chr&gt;      &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
## 1 DF          7.02   48     39.5    39    33     2.77  0.093   0.182 
## 2 pods.plant 48.1    46.6   14.8    13.4   2.6   7.11  0.238   0.467 
## 3 seeds.pod  21.3     7.6    4.82    4.8   2.6   1.02  0.0343  0.0673
## 4 sw         32.9    67     35.2    35    15.3  11.6   0.389   0.763 
## 5 yield      43.0  5153.  1754.   1602.  498.  754.   25.3    49.6
```
]
]

---

#### Checking for Outliers: Visuals

.panelset[
.panel[.panel-name[Code]

```r
#Checking for potential outliers in yield variable

find_outliers(bean_data, var = yield, plots =T)
```



]

.panel[.panel-name[Output]

Trait: yield 
Number of possible outliers: 37 
Line(s): 10 28 32 35 58 66 68 69 74 75 84 93 109 127 131 134 157 165 167 168 173 174 183 192 208 209 226 230 233 256 264 266 267 272 273 282 291 
Proportion: 4.3%
Mean of the outliers: 4314.67 
Maximum of the outliers: 5152.6  | Line 208 
Minimum of the outliers: 3241.9  | Line 28 
With outliers:    mean = 1754.348 | CV = 42.991%
Without outliers: mean = 1643.421 | CV = 32.131%

&lt;img src="index_files/figure-html/outliers2-1.png" width="504" /&gt;.panel[.panel-name[Code]

```r
#change var = var_name to get potential outliers for another variable 
```



]

.panel[.panel-name[Output]



]
]

---

#### Checking for Outliers: Looking at Data Points

Let's take a look at which data point are the outliers. Are they all the same location or same genotypes? 

.panelset[
.panel[.panel-name[Code]

```r
#potential outliers
yield_outliers &lt;- c(10, 28, 32, 35, 58, 66, 68, 69, 74 ,75, 84, 93, 109, 127, 131, 134, 157, 165, 167, 168, 173, 174, 183, 192, 208, 209, 226, 230, 233, 256, 264, 266, 267, 272, 273, 282, 291)

yo &lt;- bean_data %&gt;%
  slice(yield_outliers) %&gt;%
  arrange(Genotype) %&gt;%
  slice(1:15)

yo
```



]

.panel[.panel-name[Output]

```
##      Site Rep      Genotype DF pods.plant seeds.pod sw  yield
## 1  Selian   1        Cheupe 44       44.8       7.6 33 5085.3
## 2  Selian   2        Cheupe 44       46.2       7.4 33 5127.8
## 3  Selian   3        Cheupe 43       46.6       6.8 33 5152.6
## 4  Selian   3 Chumba Neroza 38       15.4       5.8 31 3478.7
## 5  Selian   1        Kanade 38       24.2       5.4 42 3241.9
## 6  Selian   2        Kanade 38       23.8       5.4 42 3245.4
## 7  Selian   3        Kanade 39       24.8       5.4 42 3291.5
## 8  Selian   1       Katuku2 39       36.2       5.2 40 4309.2
## 9  Selian   2       Katuku2 39       35.2       5.0 40 4256.0
## 10 Selian   3       Katuku2 39       35.0       5.4 40 4245.4
## 11 Selian   1        Kikobe 39       35.2       6.2 27 3306.3
## 12 Selian   2        Kikobe 39       36.8       6.4 27 3285.1
## 13 Selian   3        Kikobe 39       34.0       5.8 27 3355.9
## 14 Selian   1  Nyeupe Kubwa 39       27.6       5.8 35 4419.1
## 15 Selian   2  Nyeupe Kubwa 39       27.0       6.2 35 4298.6
```



]
]

---

## Grand Mean Yield of Genotypes Across Locations

We can see the grand Mean Yield for each genotype across all three locations using the means_by() function.  

.panelset[
.panel[.panel-name[R Code]

```r
#getting means by Genotype
mg &lt;- means_by(bean_data, Genotype)

#Creating a new object with Ordered Means by Genotype
mg_y &lt;- mg %&gt;%
  select(Genotype, yield) %&gt;%
  arrange(desc(yield))
```
]

.panel[.panel-name[Table]

```r
slice(mg_y, 1:10)
```

```
## # A tibble: 10 x 2
##    Genotype     yield
##    &lt;fct&gt;        &lt;dbl&gt;
##  1 Cheupe       3144.
##  2 Selian 15    3086.
##  3 Ruondera     2906.
##  4 Nyeupe Kubwa 2894.
##  5 Selian 14    2778.
##  6 Uyole 84     2722.
##  7 Selian 05    2711.
##  8 Soya Mbeya   2680.
##  9 Kikobe       2546.
## 10 Jabeyila     2476.
```
]
]

---

## Yield Means Across Genotypes at Each Location

Now, let's take a look at the grand mean at each locations across all 99 genotypes using the means_by() function. 

.panelset[
.panel[.panel-name[Code]

```r
#getting means for all variables by Location
me &lt;- means_by(bean_data, Site)

#Creating a new object with Ordered Means by Location
me_y &lt;- me %&gt;%
  select(Site, yield) %&gt;%
  arrange(desc(yield))
```
]

.panel[.panel-name[Output]

```r
me_y
```

```
## # A tibble: 3 x 2
##   Site   yield
##   &lt;fct&gt;  &lt;dbl&gt;
## 1 Selian 2336.
## 2 Uyole  1579.
## 3 SUA    1347.
```
]
]

---

## Top Performers at Each Location

We can use the ge_winners() function to get the top performing genotype at each location across all response variables. 


```r
#top performing genotype in each env for yield
win &lt;- ge_winners(.data = bean_data, 
                  env = Site, 
                  gen = Genotype, 
                  resp = c(DF, pods.plant, seeds.pod, sw, yield), type = "winners")
```


```r
print(win)
```

```
## # A tibble: 3 x 6
##   ENV    DF              pods.plant   seeds.pod sw          yield    
##   &lt;fct&gt;  &lt;chr&gt;           &lt;chr&gt;        &lt;chr&gt;     &lt;chr&gt;       &lt;chr&gt;    
## 1 Selian Kamosi          Cheupe       Cheupe    Lyamungo 90 Cheupe   
## 2 SUA    Kaisho kamugole Cheupe       Kaempu    Lyamungo 90 Jabeyila 
## 3 Uyole  Selian 15       Wifi Nyegela Cheupe    Selian 15   Selian 14
```

---
class: middle, , center

## Analysis of Variance (ANOVA): Introduction 

Running an ANOVA allows us to 

* see if genotype main effect, environment main effect and GxE interaction effect are significant

* see which effect contributes most to the variation in performance of the different traits

#### The metan package provides &lt;a href = "https://tiagoolivoto.github.io/metan/reference/index.html"&gt;many functions&lt;/a&gt; that can be used to run ANOVA. Different functions are available based on the ANOVA type (one-way, two-way), type of model (fixed or mixed effect), etc. 

---

## ANOVA for RCBD

anova_joint() is the function used for combined site analysis.

#### get the anova table for the respinse variable you want through anova_object_name$var_name$anova to 



.panelset[
.panel[.panel-name[R Code]

```r
#Running joint anova for rcbd layout/plot design for all repsonse variables

anova_joint(bean_data, env = "Site", gen = "Genotype", rep = "Rep", resp = everything())
```
]
.panel[.panel-name[Yield ANOVA Table]

```r
#getting the ANOVA table for yield 
rcbd_anova_yield &lt;- rcbd_anova$yield$anova
rcbd_anova_yield
```

```
##      Source          Df      Sum Sq     Mean Sq     F value        Pr(&gt;F)
## 1       ENV    2.000000 158874976.4 79437488.20 3943.977619  0.000000e+00
## 2  REP(ENV)    6.000000    759885.9   126647.66    6.287907  2.023559e-06
## 3       GEN   98.000000 199047400.1  2031095.92  100.841517 1.451699e-310
## 4   GEN:ENV  196.000000 135738882.9   692545.32   34.384059 1.554893e-232
## 5 Residuals  588.000000  11843181.6    20141.47          NA            NA
## 6     CV(%)    8.089650          NA          NA          NA            NA
## 7 MSR+/MSR-    6.288451          NA          NA          NA            NA
## 8    OVmean 1754.348260          NA          NA          NA            NA
```
]
.panel[.panel-name[SW ANOVA Table]

```r
#getting the ANOVA table for 100g seed weight
rcbd_anova$sw$anova
```

```
##      Source         Df      Sum Sq      Mean Sq      F value    Pr(&gt;F)
## 1       ENV   2.000000 27392.54795 1.369627e+04 51909.689778 0.0000000
## 2  REP(ENV)   6.000000     2.41064 4.017733e-01     1.522745 0.1681973
## 3       GEN  98.000000 85390.26909 8.713293e+02  3302.389579 0.0000000
## 4   GEN:ENV 196.000000  6922.37872 3.531826e+01   133.858293 0.0000000
## 5 Residuals 588.000000   155.14269 2.638481e-01           NA        NA
## 6     CV(%)   1.458387          NA           NA           NA        NA
## 7 MSR+/MSR-   2.315797          NA           NA           NA        NA
## 8    OVmean  35.221212          NA           NA           NA        NA
```
]
.panel[.panel-name[DF ANOVA Table]

```r
#getting the ANOVA table for days to 75% flowering
rcbd_anova$DF$anova
```

```
##      Source         Df      Sum Sq    Mean Sq    F value        Pr(&gt;F)
## 1       ENV   2.000000  376.141414 188.070707 744.253705 7.959563e-162
## 2  REP(ENV)   6.000000    6.747475   1.124579   4.450306  2.041800e-04
## 3       GEN  98.000000 3804.080808  38.817151 153.611421  0.000000e+00
## 4   GEN:ENV 196.000000 2515.858586  12.836013  50.796057 6.659219e-278
## 5 Residuals 588.000000  148.585859   0.252697         NA            NA
## 6     CV(%)   1.271386          NA         NA         NA            NA
## 7 MSR+/MSR-   2.591123          NA         NA         NA            NA
## 8    OVmean  39.538721          NA         NA         NA            NA
```
]
]

---

## Estimating Variance Components

#### Variance components can be calculated using the results from the ANOVA table. Use indexing to get the correct value from the anova table. 

#### anova_table[row_number, col_number]

.panelset[
.panel[.panel-name[Calculating Values]

```r
#variance of line
Vl.yd &lt;- (rcbd_anova_yield[3,4] - rcbd_anova_yield[4,4])/(3*3)

#variance of line by site
Vls.yd &lt;- (rcbd_anova_yield[4,4] - rcbd_anova_yield[5,4])/(3)

#variance of error
Ve.yd &lt;- rcbd_anova_yield[5,4]

#Broad sense hertitability 
H2.yd &lt;- Vl.yd/(Vl.yd + Vls.yd + Ve.yd)

#Hertitability of Line Means
H2L.yd &lt;- Vl.yd/(Vl.yd + Vls.yd/3 + Ve.yd/(3*3))
```
]

.panel[.panel-name[Combing Values into Table]

```r
comb.site.vc &lt;- cbind(rbind(Vl.yd, Vls.yd, Ve.yd, H2.yd, H2L.yd))

colnames(comb.site.vc) &lt;- c("Yield")
rownames(comb.site.vc) = c("V of Line", "V of Line x Site", "V of Error", "Broad Sense Heritability", "Heritability of Line Means")
```
]

.panel[.panel-name[Final Output]

```r
print(comb.site.vc)
```

```
##                                   Yield
## V of Line                  1.487278e+05
## V of Line x Site           2.241346e+05
## V of Error                 2.014147e+04
## Broad Sense Heritability   3.784386e-01
## Heritability of Line Means 6.590287e-01
```
]
]

---
class: middle, center

## Genotype plus genotype-by-environment (GGE) Models &amp; Biplots


#### The gge() function can be used to create a gge model. 

--

First, the centering argument needs to be set to "environment" for us to get a GGE model. 

--

Then the svp argument can be used to create three types of gge biplots. Below are the three options: 

* svp = "environment"
* svp = "genotype"
* svp = "symmetrical"

---
class: middle, center

# Let's start with svp = "environment"

---



.panelset[
.panel[.panel-name[Create Model]

```r
gge_model &lt;- gge(.data = bean_data,
                 env = Site,
                 gen = Gen_id,
                 resp = yield,
                 centering = "environment",
                 svp = "environment")
```
]
.panel[.panel-name[Create Plot]

```r
#creating the plot
*gge_biplot &lt;- plot(gge_model,
                   
                   plot_theme = theme_xaringan(css_file =  "C:/Users/eruph/Documents/git repos for r/xaringan-decks/GxE-June2022/xaringan-themer.css",
  text_font_size = 12,
  title_font_size = 14)) +
  ylim(-4500,3000)
```
]
.panel[.panel-name[Basic Biplot]

```r
#call the name of the plot to view it
gge_biplot
```

&lt;img src="index_files/figure-html/plot-basic-biplot-1.png" width="504" /&gt;
]
]

---

.panelset[
.panel[.panel-name[R Code]
The discriminativeness vs. representativeness plot is created by setting the type argument to 4.

```r
*dvr &lt;- plot(gge_model, type = 4,
            
             plot_theme = theme_xaringan(css_file =  "C:/Users/eruph/Documents/git repos for r/xaringan-decks/GxE-June2022/xaringan-themer.css",
  text_font_size = 12,
  title_font_size = 14)) +
  ylim(-4500,3000)
```
*Disregard the plot_theme argument for now
]
.panel[.panel-name[Plot]
.pull-left[

```r
dvr
```

&lt;img src="index_files/figure-html/plot-dvr-1.png" width="504" /&gt;
]
.pull-right[
Selian has the longest vector. We can look at yield performance at Selian and get more information about the yield of the genotypes than at SUA or Uyole.
The longer the vector of that environment, the more information about genotype performance for the variable. 
]
]
]

---

.panelset[
.panel[.panel-name[R Code]

Let's compare the environments using another biplot. Change the type to 6 to rank environments and set type to 10 to visualize a clear relationship of the environments. 


```r
#creating plot 1: ranking environments
*ranking_envrion &lt;- plot(gge_model, type=6,
                        plot_theme = theme_xaringan(css_file =  "C:/Users/eruph/Documents/git repos for r/xaringan-decks/GxE-June2022/xaringan-themer.css",
  text_font_size = 12,
  title_font_size = 14)) +
  ylim(-4500,3000)

#creating plot 2:relationship among environment
*relationship &lt;- plot(gge_model, type = 10,
                     
                     plot_theme = theme_xaringan(css_file =  "C:/Users/eruph/Documents/git repos for r/xaringan-decks/GxE-June2022/xaringan-themer.css",
  text_font_size = 12,
  title_font_size = 14)) +
  ylim(-4500,3000)
```
]
.panel[.panel-name[Type = 6 Plot]


```r
ranking_envrion
```

&lt;img src="index_files/figure-html/ranking-plot-1.png" width="504" /&gt;
]
.panel[.panel-name[Type = 10 Plot]

```r
relationship
```

&lt;img src="index_files/figure-html/comparing-env-biplots-1.png" width="504" /&gt;
]
]

---
class: middle, center

### Now let's try svp = "genotype"

---

Now, let's create an svp = "environment" model. 


```r
gge_model_gen &lt;- gge(.data = bean_data,
                 env = Site,
                 gen = Gen_id,
                 resp = yield,
                 centering = "environment",
                 svp = "environment")
```

---

##### Svp = "genotype" Biplots

.panelset[
.panel[.panel-name[R Code]
explain plot types


```r
# 5 mean performance vs stability 
*mean_vs_stability &lt;- plot(gge_model_gen, type =2,
                          
                          plot_theme = theme_xaringan(css_file =  "C:/Users/eruph/Documents/git repos for r/xaringan-decks/GxE-June2022/xaringan-themer.css",
  text_font_size = 12,
  title_font_size = 14)) +
  ylim(-4500,3000)

#examining the performance a particular genotype
#genotype Selian 06

*genotype.87 &lt;-plot(gge_model_gen, type =7, sel_gen = "87",
                   
                   plot_theme = theme_xaringan(css_file =  "C:/Users/eruph/Documents/git repos for r/xaringan-decks/GxE-June2022/xaringan-themer.css",
  text_font_size = 12,
  title_font_size = 14)) +
  ylim(-4500,4000)

# Ranking genotype 
*rank_genotype &lt;- plot(gge_model_gen, type=8,
                      
                      plot_theme = theme_xaringan(css_file =  "C:/Users/eruph/Documents/git repos for r/xaringan-decks/GxE-June2022/xaringan-themer.css",
  text_font_size = 12,
  title_font_size = 14)) +
  ylim(-4500,3000)
```
]
.panel[.panel-name[Type = 2 Plot]


```r
mean_vs_stability
```

&lt;img src="index_files/figure-html/mean-perf-vs-stability-plot-1.png" width="504" /&gt;
]
.panel[.panel-name[Type = 7 Plot]

```r
genotype.87
```

&lt;img src="index_files/figure-html/type-7-plot-1.png" width="504" /&gt;
]
.panel[.panel-name[Type = 8 Plot]

```r
rank_genotype
```

&lt;img src="index_files/figure-html/type-8-plot-1.png" width="504" /&gt;
]
]


---
class: middle, center

### Finally let's look at svp = "symmetrical". 


---

.panelset[
.panel[.panel-name[Create Biplot]

```r
gge_symmetrical &lt;- gge(.data = bean_data,
                 env = Site,
                 gen = Gen_id,
                 resp = yield,
                 centering = "environment",
                 svp = "symmetrical")
```

]
.panel[.panel-name[R Code]

```r
# which won where 
*which_won_where &lt;- plot(gge_symmetrical, type=3,
                        
                        
                        plot_theme = theme_xaringan(css_file =  "C:/Users/eruph/Documents/git repos for r/xaringan-decks/GxE-June2022/xaringan-themer.css",
  text_font_size = 12,
  title_font_size = 14)) +
  ylim(-60,25)

#Exmaine an env
*examine_Selian &lt;- plot(gge_symmetrical, type=1, sel_env = "Selian",
                       
                       plot_theme = theme_xaringan(css_file =  "C:/Users/eruph/Documents/git repos for r/xaringan-decks/GxE-June2022/xaringan-themer.css",
  text_font_size = 12,
  title_font_size = 14)) +
  ylim(-60,25)

#Comparing 2 genotypes 

*compare_two_gen &lt;- plot(gge_symmetrical, type=9, sel_gen1 = "15", sel_gen2 = "69",
                        
                        plot_theme = theme_xaringan(css_file =  "C:/Users/eruph/Documents/git repos for r/xaringan-decks/GxE-June2022/xaringan-themer.css",
  text_font_size = 12,
  title_font_size = 14)) +
  ylim(-60,25)
```
]
.panel[.panel-name[Type = 3 Plot]

```r
which_won_where
```

&lt;img src="index_files/figure-html/type-3-plot-1.png" width="504" /&gt;
]
.panel[.panel-name[Type = 1 Plot]

```r
examine_Selian
```

&lt;img src="index_files/figure-html/type-1-plot-1.png" width="504" /&gt;
]
.panel[.panel-name[Type = 9 Plot]

```r
compare_two_gen
```

&lt;img src="index_files/figure-html/type-9-plot-1.png" width="504" /&gt;
]
]

---
class: middle, center

## Additive Main-Effects Multiplicative Interaction (AMMI)

AMMI deals with average performances and specific performances/GxE interaction. 

* Addive Main-Effects:
  * Genotype Main Effect
  * Environment Main Effect
  
* Multiplicative Interaction
  * Genotype * Environment Interaction Effect 

---

##### Creating an AMMI Model

.panelset[
.panel[.panel-name[AMMI Model]
Use performs_ammi() to create an ammi object. From the ammi object, you can get:

* ANOVA table
* PCA 
* AMMI model scores
* means of genotypes in the environments

```r
ammi &lt;- performs_ammi(.data = bean_data, 
                      env = Site, 
                      gen = Gen_id, 
                      rep = Rep,
                      resp = yield)
```
]
.panel[.panel-name[AMMI ANOVA]

```r
ammi$yield$ANOVA
```

```
*##      Source   Df      Sum Sq     Mean Sq    F value        Pr(&gt;F) Proportion
*## 1       ENV    2 158874976.4 79437488.20 627.232194  1.078604e-07         NA
*## 2  REP(ENV)    6    759885.9   126647.66   6.287907  2.023559e-06         NA
*## 3       GEN   98 199047400.1  2031095.92 100.841517 1.451699e-310         NA
*## 4   GEN:ENV  196 135738882.9   692545.32  34.384059 1.554893e-232         NA
*## 5       PC1   99 112959941.7  1141009.51  56.650000  0.000000e+00       83.2
## 6       PC2   97  22778941.2   234834.45  11.660000  0.000000e+00       16.8
## 7 Residuals  588  11843181.6    20141.47         NA            NA         NA
## 8     Total 1086 642003209.7   591163.18         NA            NA         NA
##   Accumulated
## 1          NA
## 2          NA
## 3          NA
## 4          NA
## 5        83.2
## 6       100.0
## 7          NA
## 8          NA
```
]
.panel[.panel-name[AMMI Plot]

```r
*residual_plots(ammi
               
               , nrow = 2, 
               plot_theme = theme_xaringan(css_file =  "C:/Users/eruph/Documents/git repos for r/xaringan-decks/GxE-June2022/xaringan-themer.css",
  text_font_size = 12,
  title_font_size = 14))
```

&lt;img src="index_files/figure-html/ammi-plot-1.png" width="504" /&gt;
]
]

---

###### AMMI Biplots



.panelset[
.panel[.panel-name[Creating the plots]

```r
#ab2
plot_scores(ammi)
```

&lt;img src="index_files/figure-html/creating-plots-1.png" width="504" /&gt;

```r
#b2
plot_scores(ammi, type=2)
```

&lt;img src="index_files/figure-html/creating-plots-2.png" width="504" /&gt;

```r
#b2 polygon
plot_scores(ammi, type=2, polygon=T)
```

&lt;img src="index_files/figure-html/creating-plots-3.png" width="504" /&gt;

```r
#b2 other
plot_scores(ammi,
                  type=2,
                  col.env = "green4",
                  col.segm.env = "orange",
                  highlight = c("1", "2"),
                  col.highlight = "darkcyan",
                  axis.expand = 1.5)
```

&lt;img src="index_files/figure-html/creating-plots-4.png" width="504" /&gt;

```r
#all plots together
all_plots &lt;- arrange_ggplot(ab2, b2, b2_polygon, b2_other, tag_levels="a", nrow=2) 
```
]
.panel[.panel-name[ab2]

```r
ab2
```

&lt;img src="index_files/figure-html/ab2-1.png" width="504" /&gt;
]

.panel[.panel-name[b2]

```r
b2
```

&lt;img src="index_files/figure-html/b2-1.png" width="504" /&gt;
]

.panel[.panel-name[b2_polygon]

```r
b2_polygon
```

&lt;img src="index_files/figure-html/b2-polygon-1.png" width="504" /&gt;
]

.panel[.panel-name[b2_other]

```r
b2_other
```

&lt;img src="index_files/figure-html/b2-other-1.png" width="504" /&gt;
]
.panel[.panel-name[all plots]

```r
all_plots 
```

&lt;img src="index_files/figure-html/all-plots-together-1.png" width="504" /&gt;
]
]

---

Genotypes on the right have higher yield 
Genotypes with a PCA1 value closer to 0 experienced less GXE interaction = more stable. 
Environments closer the the PCA 1 = 0 line contributed the least to GxE interactions.

---
class: middle, center

## Ranks: Yield Output and Stability 

#### Ammi Stability Value (ASV) and Yield Stability Index (YSI) are the metrics I use/come across most frequently. Ranking genotypes using these metrics is useful because it takes into consideration both yield output and stability. 

--

#### ASV: genotypes with low ASV values are more stable and vice versa. 

--

#### YSI takes into account both stability and yield output making it a better method to identify high yielding and stable genotypes. Lower YSI have both high mean yield and stability traits. 

---
class: middle, center

## Follow Up Resources 

The link to this presentation will be emailed to you, along with a pdf copy.

Check out my &lt;a href = "https://rforplantbreeders.netlify.app/"&gt; blog &lt;/a&gt; for more detailed written tutorials for plant breeders who want to learn how to use R. 

Current Posts:

*  &lt;a href = "https://rforplantbreeders.netlify.app/posts/introduction-to-r-for-plant-breeding/"&gt; Introduction to R &lt;/a&gt;
*  &lt;a href = "https://rforplantbreeders.netlify.app/posts/importing-data-into-r/"&gt; Importing in R &lt;/a&gt;

---
class: middle, center

# Any Questions? 

    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false,
"ratio": "16:9"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
