---
title: "GxE Analysis Workshop"
author: "Ellena Girma"
date: "2022/05/27 (updated: `r Sys.Date()`)"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: 16:9
---
class: middle, center

```{r setup, include=FALSE }
knitr::opts_chunk$set(echo = TRUE, fig.retina=3)

```

```{r xaringan-themer, include=FALSE, warning=FALSE}
library(xaringanthemer)
style_mono_accent(
  base_color = "#1c5253",
  header_font_google = google_font("Josefin Sans"),
  text_font_google   = google_font("Montserrat", "300", "300i"),
  code_font_google   = google_font("Fira Mono")
)
```

```{r style-share-again, echo=FALSE}
xaringanExtra::style_share_again(
  share_buttons = c("twitter", "linkedin", "pocket")
)
```


```{r xaringan-panelset, echo=FALSE}
xaringanExtra::use_panelset()
```

```{r xaringanExtra-clipboard, echo=FALSE}
xaringanExtra::use_clipboard(
  button_text = "Copy to clipboard",
  success_text = "Copied",
  error_text = "Press Ctrl + C para to copy"
)
```

### Hello Everyone! My name is Ellena Girma and I am a data analyst intern at CIAT. 

--

#### The goal of this presentation is to demonstrate how R can be used to run GxE analyses.

--

#### I will take you through the workflow that I use to run my GxE analysis. For each part, I will cover the main functions that I use and what outputs/results you can expect to get.

---

## Introduction to GxE Studies 

.pull-left[
#### Understanding Genotype-Environment (GxE) Interaction
* GXE interaction: the interaction of genotypes and environmental conditions and its joint effect on the traits being selected

* Is there a pattern of phenotypic expression of the selected trait across various environmental conditions? 
]

--

.pull-right[
#### Selecting & recommending genotypes that have wider or more specific adaptation across various environmental conditions

* Stability: Does the performance of the genotype stay the same across environments?

* Yield Production: Does the genotype perform well across environments? 
]

---

## My Workflow

#### In this presentation I will be sharing the process I use to get from raw data to results. I will be focusing on the response variable yield, but the code I use can be altered for other response variables too. 

Workflow:

* Data Preparation 

* Exploratory Data Analysis

* Means and High Yielding Genotypes & Locations

* Analysis of Variance (ANOVA)

* GGE Biplots

* Stability Analysis

* Additive Main-Effects Multiplicative Interaction (AMMI)

---
class: middle, center

## Let's take a quick tour of R. 



## For this workshop, we'll be focusing on the metan package.

---

## Loading Packages and Importing Data

```{r set-up-workspace-hidden, include = FALSE}
library(xaringan)
library(xaringanthemer)
library(xaringanExtra)

```

```{r importing-and-loading, message = FALSE}

#loading metan package into workspace
#for analysis
library(metan)

#loading tidyverse package into workspace
#for data manipulation functions
library(tidyverse)

#importing a csv file using the read.csv() function
bean_data <- read.csv("C:/Users/eruph/Documents/TB/Importing_Blog/csvfile.csv", 
                      header=TRUE,
                      colClasses = c(rep("factor", 3), rep("numeric", 5)))

```

---
class: middle

## Exploratory Data Analysis (EDA)

### Exploring and summarizing datasets using summary statistics and plots/data visualization methods.

--

EDA allows us to:

* find outliers

* see how our data is distributed

* see the relationship between variables

* get summary statistics for each variable of interest

---

## Summary Statistics

.panelset[
.panel[.panel-name[R Code]
```{r summary_stats-p1}

#summary of data
summary <- summary(bean_data)

#count number of fields that are missing
sum(is.na(bean_data))

#descriptive stats using metan package
ds_all <- desc_stat(bean_data, stats= "main")


```
]

.panel[.panel-name[summary output]
```{r summary_stats-pt2}

print(summary)

```
]

.panel[.panel-name[desc_stats output]
```{r summary_stats-pt3}

print(ds_all)

```
]
]

---

#### Checking for outliers: Plots

.panelset[
.panel[.panel-name[Code]
This is for the variable yield. To get potential outliers for another variable, set var to var_name.
```{r yield-outliers-plotcode, fig.show='hide'}
#Checking for potential outliers in yield variable
find_outliers(bean_data, var = yield, plots =T)
```
]
.panel[.panel-name[Plot]
```{r yield-outliers-plots}
find_outliers(bean_data, var = yield, plots =T)
```
]
]

---

### Checking for Outliers: Looking at Data Points

Let's take a look at which data point are the outliers. Are they all the same location or same genotypes? 

.panelset[
```{r yield-outliers, panelset = TRUE}
#potential outliers
yield_outliers <- c(10, 28, 32, 35, 58, 66, 68, 69, 74 ,75, 84, 93, 109, 127, 131, 134, 157, 165, 167, 168, 173, 174, 183, 192, 208, 209, 226, 230, 233, 256, 264, 266, 267, 272, 273, 282, 291)

yo <- bean_data %>%
  slice(yield_outliers) %>%
  arrange(Genotype) %>%
  slice(1:15)

yo
```
]

---

## Grand Mean Yield of Genotypes Across Locations

We can see the grand Mean Yield for each genotype across all three locations using the means_by() function.  

.panelset[
.panel[.panel-name[R Code]
```{r grand-yield-means-p1}
#getting means by Genotype
mg <- means_by(bean_data, Genotype)

#Creating a new object with Ordered Means by Genotype
mg_y <- mg %>%
  select(Genotype, yield) %>%
  arrange(desc(yield))
```
]

.panel[.panel-name[Table]
```{r grand-yield-means-p2}
slice(mg_y, 1:10)
```
]
]

---

## Yield Means Across Genotypes at Each Location

Now, let's take a look at the grand mean at each location using the means_by() function. 

.panelset[
.panel[.panel-name[Code]
```{r yield-means-location}
#getting means for all variables by Location
me <- means_by(bean_data, Site)

#Creating a new object with Ordered Means by Location
me_y <- me %>%
  select(Site, yield) %>%
  arrange(desc(yield))
```
]

.panel[.panel-name[Output]
```{r yield-means-location-print}
me_y
```
]
]

---

## Top Performers at Each Location

We can use the ge_winners() function to get the top performing genotype at each location across all response variables. 

```{r top-genotype-across-loc}
#top performing genotype in each env for yield
win <- ge_winners(.data = bean_data, 
                  env = Site, 
                  gen = Genotype, 
                  resp = c(DF, pods.plant, seeds.pod, sw, yield), type = "winners")
```

```{r print-top-genotype-across-loc}
print(win)
```

---
class: middle

## Analysis of Variance (ANOVA): Introduction 

#### Running an ANOVA allows us to 

* see if genotype main effect, environment main effect and GxE interaction effect are significant

* see which effect contributes most to the variation in performance of the different traits

#### The metan package provides <a href = "https://tiagoolivoto.github.io/metan/reference/index.html">many functions</a> that can be used to run ANOVA. Different functions are available based on the ANOVA type (one-way, two-way), type of model (fixed or mixed effect), etc. 

---

## ANOVA for RCBD

#### anova_joint() is the function used for combined site analysis.

#### get the anova table for the respinse variable you want through anova_object_name$var_name$anova to 

```{r hidden-assignment, include=FALSE}
rcbd_anova <- anova_joint(bean_data, env = "Site", gen = "Genotype", rep = "Rep", resp = everything())
```

.panelset[
.panel[.panel-name[R Code]
```{r rcbd-anova, results='hide', warning=FALSE}

#Running joint anova for rcbd layout/plot design for all repsonse variables

anova_joint(bean_data, env = "Site", gen = "Genotype", rep = "Rep", resp = everything())
```
]
.panel[.panel-name[Yield ANOVA Table]
```{r Yield-ANOVA-Table}
#getting the ANOVA table for yield 
rcbd_anova_yield <- rcbd_anova$yield$anova
rcbd_anova_yield
```
]
.panel[.panel-name[SW ANOVA Table]
```{r SW-ANOVA-Table}
#getting the ANOVA table for 100g seed weight
rcbd_anova$sw$anova

```
]
.panel[.panel-name[DF ANOVA Table]
```{r DF-ANOVA-Table}
#getting the ANOVA table for days to 75% flowering
rcbd_anova$DF$anova

```
]
]

---

## Estimating Variance Components

#### Variance components can be calculated using the results from the ANOVA table. Use indexing to get the correct value from the anova table. 

#### anova_table[row_number, col_number]

.panelset[
.panel[.panel-name[Calculating Values]
```{r variance-components-p1}
#variance of line
Vl.yd <- (rcbd_anova_yield[3,4] - rcbd_anova_yield[4,4])/(3*3)

#variance of line by site
Vls.yd <- (rcbd_anova_yield[4,4] - rcbd_anova_yield[5,4])/(3)

#variance of error
Ve.yd <- rcbd_anova_yield[5,4]

#Broad sense hertitability 
H2.yd <- Vl.yd/(Vl.yd + Vls.yd + Ve.yd)

#Hertitability of Line Means
H2L.yd <- Vl.yd/(Vl.yd + Vls.yd/3 + Ve.yd/(3*3))

```
]

.panel[.panel-name[Combing Values into Table]
```{r variance-components-p2}
comb.site.vc <- cbind(rbind(Vl.yd, Vls.yd, Ve.yd, H2.yd, H2L.yd))

colnames(comb.site.vc) <- c("Yield")
rownames(comb.site.vc) = c("V of Line", "V of Line x Site", "V of Error", "Broad Sense Heritability", "Heritability of Line Means")


```
]

.panel[.panel-name[Final Output]
```{r variance-components-table}
print(comb.site.vc)
```
]
]

---
class: middle

## Genotype plus genotype-by-environment (GGE) Models & Biplots

--

#### The gge() function can be used to create a gge model. 

--

#### First, the centering argument needs to be set to "environment" for us to get a GGE model. 

--

#### Then the svp argument can be used to create three types of gge biplots. Below are the three options: 

* svp = "environment"

* svp = "genotype"

* svp = "symmetrical"

---
class: middle, center

# Let's start with svp = "environment"

---

```{r creating-gen_id_codes, include=FALSE}
# Creating new factor 

bean_data$Gen_id <- as.numeric(factor(bean_data$Genotype, levels =  unique((bean_data$Genotype))))

gen_id_codes <- bean_data %>%
  distinct(Genotype, Gen_id)
```

.panelset[
.panel[.panel-name[Create Model]
```{r create-gge-model}
gge_model <- gge(.data = bean_data,
                 env = Site,
                 gen = Gen_id,
                 resp = yield,
                 centering = "environment",
                 svp = "environment")

```
]
.panel[.panel-name[Create Plot]
```{r basic-biplot, warning = FALSE, message=FALSE, fig.height = 15}
#creating the plot
gge_biplot <- plot(gge_model, #<<
                   
                   plot_theme = theme_xaringan(css_file =  "C:/Users/eruph/Documents/git repos for r/xaringan-decks/GxE-June2022/xaringan-themer.css",
  text_font_size = 12,
  title_font_size = 14)) +
  ylim(-4500,3000)

```
]
.panel[.panel-name[Basic Biplot]
```{r plot-basic-biplot, message=FALSE, warning=FALSE}
#call the name of the plot to view it
gge_biplot

```
]
]

---

.panelset[
.panel[.panel-name[R Code]
The discriminativeness vs. representativeness plot is created by setting the type argument to 4.
```{r creating-dvr, warning=FALSE, message=FALSE}
dvr <- plot(gge_model, type = 4, #<<
            
             plot_theme = theme_xaringan(css_file =  "C:/Users/eruph/Documents/git repos for r/xaringan-decks/GxE-June2022/xaringan-themer.css",
  text_font_size = 12,
  title_font_size = 14)) +
  ylim(-4500,3000)
```
]
.panel[.panel-name[Plot]

Selian has the longest vector. We can look at yield performance at Selian and get more information about the yield of the genotypes than at SUA or Uyole.
The longer the vector of that environment, the more information about genotype performance for the variable. 

```{r plot-dvr, message=FALSE, warning=FALSE}
dvr
```
]
]

---

.panelset[
.panel[.panel-name[R Code]

Let's compare the environments using another biplot. Change the type to 6 to rank environments and set type to 10 to visualize a clear relationship of the environments. 

```{r comparing-biplots, message=FALSE}
#creating plot 1: ranking environments
ranking_envrionment <- plot(gge_model, type=6, #<<  
                        plot_theme = theme_xaringan(css_file =  "C:/Users/eruph/Documents/git repos for r/xaringan-decks/GxE-June2022/xaringan-themer.css",
  text_font_size = 12,
  title_font_size = 14)) +
  ylim(-4500,3000)

#creating plot 2:relationship among environment
relationship <- plot(gge_model, type = 10, #<<
                     
                     plot_theme = theme_xaringan(css_file =  "C:/Users/eruph/Documents/git repos for r/xaringan-decks/GxE-June2022/xaringan-themer.css",
  text_font_size = 12,
  title_font_size = 14)) +
  ylim(-4500,3000)

```
]
.panel[.panel-name[Type = 6 Plot]

```{r ranking-plot, message=FALSE, warning=FALSE}
ranking_envrionment
```
]
.panel[.panel-name[Type = 10 Plot]
```{r comparing-env-biplots, message=FALSE, warning=FALSE}
relationship
```
]
]

---
class: middle, center

# Now, let's try svp = "genotype"

---

```{r create-gge-model-2}
gge_model_gen <- gge(.data = bean_data,
                 env = Site,
                 gen = Gen_id,
                 resp = yield,
                 centering = "environment",
                 svp = "environment")

```

---

##### Svp = "genotype" Biplots

.panelset[
.panel[.panel-name[R Code]
explain plot types

```{r genotype-biplots-code, warning=FALSE, message=FALSE}

# 5 mean performance vs stability 
mean_vs_stability <- plot(gge_model_gen, type =2, #<<
                          
                          plot_theme = theme_xaringan(css_file =  "C:/Users/eruph/Documents/git repos for r/xaringan-decks/GxE-June2022/xaringan-themer.css",
  text_font_size = 12,
  title_font_size = 14)) +
  ylim(-4500,3000)

#examining the performance a particular genotype
#genotype Selian 06

genotype.87 <-plot(gge_model_gen, type =7, sel_gen = "87", #<<
                   
                   plot_theme = theme_xaringan(css_file =  "C:/Users/eruph/Documents/git repos for r/xaringan-decks/GxE-June2022/xaringan-themer.css",
  text_font_size = 12,
  title_font_size = 14)) +
  ylim(-4500,4000)

# Ranking genotype 
rank_genotype <- plot(gge_model_gen, type=8, #<<
                      
                      plot_theme = theme_xaringan(css_file =  "C:/Users/eruph/Documents/git repos for r/xaringan-decks/GxE-June2022/xaringan-themer.css",
  text_font_size = 12,
  title_font_size = 14)) +
  ylim(-4500,3000)

```
]
.panel[.panel-name[Type = 2 Plot]

```{r mean-perf-vs-stability-plot, message=FALSE, warning=FALSE}
mean_vs_stability
```
]
.panel[.panel-name[Type = 7 Plot]
```{r type-7-plot, message=FALSE, warning=FALSE}
genotype.87
```
]
.panel[.panel-name[Type = 8 Plot]
```{r type-8-plot, message=FALSE, warning=FALSE}
rank_genotype
```
]
]


---
class: middle, center

# Finally, let's look at svp = "symmetrical". 


---

.panelset[
.panel[.panel-name[Create Biplot]
```{r svp-symmetrical}
gge_symmetrical <- gge(.data = bean_data,
                 env = Site,
                 gen = Gen_id,
                 resp = yield,
                 centering = "environment",
                 svp = "symmetrical")
```

]
.panel[.panel-name[R Code]
```{r symmetrical-biplots-code, message=FALSE}
# which won where 
which_won_where <- plot(gge_symmetrical, type=3, #<<
                        
                        
                        plot_theme = theme_xaringan(css_file =  "C:/Users/eruph/Documents/git repos for r/xaringan-decks/GxE-June2022/xaringan-themer.css",
  text_font_size = 12,
  title_font_size = 14)) +
  ylim(-60,25)

#Exmaine an env
examine_Selian <- plot(gge_symmetrical, type=1, sel_env = "Selian", #<<
                       
                       plot_theme = theme_xaringan(css_file =  "C:/Users/eruph/Documents/git repos for r/xaringan-decks/GxE-June2022/xaringan-themer.css",
  text_font_size = 12,
  title_font_size = 14)) +
  ylim(-60,25)

#Comparing 2 genotypes 

compare_two_gen <- plot(gge_symmetrical, type=9, sel_gen1 = "15", sel_gen2 = "69",  #<<
                        
                        plot_theme = theme_xaringan(css_file =  "C:/Users/eruph/Documents/git repos for r/xaringan-decks/GxE-June2022/xaringan-themer.css",
  text_font_size = 12,
  title_font_size = 14)) +
  ylim(-60,25)

```
]
.panel[.panel-name[Type = 3 Plot]
```{r type-3-plot, message=FALSE, warning=FALSE}
which_won_where
```
]
.panel[.panel-name[Type = 1 Plot]
```{r type-1-plot, message=FALSE, warning=FALSE}
examine_Selian
```
]
.panel[.panel-name[Type = 9 Plot]
```{r type-9-plot, message=FALSE, warning=FALSE}
compare_two_gen
```
]
]

---
class: middle

## Additive Main-Effects Multiplicative Interaction (AMMI)

AMMI deals with average performances and specific performances/GxE interaction. 

* Addive Main-Effects:
  * Genotype Main Effect
  * Environment Main Effect
  
* Multiplicative Interaction
  * Genotype * Environment Interaction Effect 

---

##### Creating an AMMI Model

.panelset[
.panel[.panel-name[AMMI Model]
Use performs_ammi() to create an ammi object. From the ammi object, you can get:

* ANOVA table
* PCA 
* AMMI model scores
* means of genotypes in the environments
```{r ammi-model, results= 'hide'}
ammi <- performs_ammi(.data = bean_data, 
                      env = Site, 
                      gen = Gen_id, 
                      rep = Rep,
                      resp = yield)
```
]
.panel[.panel-name[AMMI ANOVA]
```{r ammi-anova, highlight.output = 1:6}
ammi$yield$ANOVA
```
]
.panel[.panel-name[AMMI Plot]
```{r ammi-plot-for-output, echo = FALSE }
residual_plots(ammi #<<
               
               , nrow = 2, 
               plot_theme = theme_xaringan(css_file =  "C:/Users/eruph/Documents/git repos for r/xaringan-decks/GxE-June2022/xaringan-themer.css",
  text_font_size = 12,
  title_font_size = 14))
```

```{r ammi-plot, results='hide'}
residual_plots(ammi)
```
]
]

---

###### AMMI Biplots

```{r creating-plots-hidden, include=FALSE}
options(ggrepel.max.overlaps = 3) 

#
ab2 <- plot_scores(ammi, x.lab = "Yield", axis.expand = 1, size.tex.gen = 2, size.tex.env = 2,
                   plot_theme = theme_xaringan(css_file =  "C:/Users/eruph/Documents/git repos for r/xaringan-decks/GxE-June2022/xaringan-themer.css",
  text_font_size = 12,
  title_font_size = 14))

#
b2 <- plot_scores(ammi, type=2,
                  plot_theme = theme_xaringan(css_file =  "C:/Users/eruph/Documents/git repos for r/xaringan-decks/GxE-June2022/xaringan-themer.css",
  text_font_size = 12,
  title_font_size = 14))

#
b2_polygon <- plot_scores(ammi, type=2, polygon=T, 
                          plot_theme = theme_xaringan(css_file =  "C:/Users/eruph/Documents/git repos for r/xaringan-decks/GxE-June2022/xaringan-themer.css",
  text_font_size = 12,
  title_font_size = 14))

#
b2_other <- plot_scores(ammi,
                  type=2,
                  col.env = "green4",
                  col.segm.env = "orange",
                  highlight = c("1", "2"), 
                  col.highlight = "darkcyan",
                  axis.expand = 1.5,
                  plot_theme = theme_xaringan(css_file =  "C:/Users/eruph/Documents/git repos for r/xaringan-decks/GxE-June2022/xaringan-themer.css",
  text_font_size = 12,
  title_font_size = 14))


#all plots together
all_plots <- arrange_ggplot(ab2, b2, b2_polygon, b2_other, tag_levels="a", nrow=2) 

```

.panelset[
.panel[.panel-name[Creating the plots]
```{r creating-plots, results='hide', warning=FALSE, eval=FALSE}
#ab2
plot_scores(ammi)

#b2
plot_scores(ammi, type=2)

#b2 polygon
plot_scores(ammi, type=2, polygon=T)

#b2 other
plot_scores(ammi,
                  type=2,
                  col.env = "green4",
                  col.segm.env = "orange",
                  highlight = c("1", "2"),
                  col.highlight = "darkcyan",
                  axis.expand = 1.5)


#all plots together
all_plots <- arrange_ggplot(ab2, b2, b2_polygon, b2_other, tag_levels="a", nrow=2) 

```
]
.panel[.panel-name[ab2]
```{r ab2, warning=FALSE}
ab2

```
]

.panel[.panel-name[b2]
```{r b2, warning=FALSE}
b2

```
]

.panel[.panel-name[b2_polygon]
```{r b2-polygon, warning=FALSE}
b2_polygon

```
]

.panel[.panel-name[b2_other]
```{r b2-other, warning=FALSE}
b2_other

```
]
.panel[.panel-name[all plots]
```{r all-plots-together, warning=FALSE}
all_plots 
```
]
]

---

Genotypes on the right have higher yield 
Genotypes with a PCA1 value closer to 0 experienced less GXE interaction = more stable. 
Environments closer the the PCA 1 = 0 line contributed the least to GxE interactions.

---
class: middle, center

# Ranks: Yield Output and Stability 

#### Ammi Stability Value (ASV) and Yield Stability Index (YSI) are the metrics I use/come across most frequently. Ranking genotypes using these metrics is useful because it takes into consideration both yield output and stability. 

--

.pull-left[
#### ASV: genotypes with low ASV values are more stable and vice versa. 
]

--

.pull-right[
#### YSI takes into account both stability and yield output making it a better method to identify high yielding and stable genotypes. Lower YSI have both high mean yield and stability traits. 
]

---
class: middle

# Follow Up Resources 

#### The link to this presentation will be emailed to you, along with a pdf copy.

#### Check out my <a href = "https://rforplantbreeders.netlify.app/"> blog </a> for more detailed written tutorials for plant breeders who want to learn how to use R. 

#### Current Posts:

*  <a href = "https://rforplantbreeders.netlify.app/posts/introduction-to-r-for-plant-breeding/"> Introduction to R </a>
*  <a href = "https://rforplantbreeders.netlify.app/posts/importing-data-into-r/"> Importing in R </a>

---
class: middle, center

# Any Questions?
#### Please feel free to ask now. 

